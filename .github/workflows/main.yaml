name: EC2 Setup and Terraform Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  setup-ec2:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up SSH key
      uses: webfactory/ssh-agent@v0.5.0
      with:
        ssh-private-key: ${{ secrets.YOUR_SSH_PRIVATE_KEY }}  # Replace with your secret name for the SSH private key

    - name: Install dependencies and configure EC2 instance
      uses: appleboy/ssh-action@master
      with:
        host: YOUR_EC2_PUBLIC_IP  # Replace with your EC2 public IP
        username: ec2-user
        script: |
          sudo su
          yum update -y
          mkdir -p /var/www/html
          sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport fs-03c9b3354880b36a6.efs.us-east-1.amazonaws.com:/ /var/www/html
          sudo yum install -y httpd httpd-tools mod_ssl
          sudo systemctl enable httpd
          sudo systemctl start httpd
          sudo amazon-linux-extras enable php7.4
          sudo yum clean metadata
          sudo yum install php php-common php-pear -y
          sudo yum install php-{cgi,curl,mbstring,gd,mysqlnd,gettext,json,xml,fpm,intl,zip} -y
          sudo rpm -Uvh https://dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm
          sudo rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2022
          sudo yum install mysql-community-server -y
          sudo systemctl enable mysqld
          sudo systemctl start mysqld
          sudo usermod -a -G apache ec2-user
          sudo chown -R ec2-user:apache /var/www
          sudo chmod 2775 /var/www && find /var/www -type d -exec sudo chmod 2775 {} \;
          sudo find /var/www -type f -exec sudo chmod 0664 {} \;
          chown apache:apache -R /var/www/html
          wget https://wordpress.org/latest.tar.gz
          tar -xzf latest.tar.gz
          cp -r wordpress/* /var/www/html/
          cp /var/www/html/wp-config-sample.php /var/www/html/wp-config.php
          # Edit the wp-config.php file here
          # nano /var/www/html/wp-config.php
          service httpd restart

  end-to-end-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: 16
      - run: cd CRC_Terraform/end-to-end-test && npm install && node index.js

  build-and-deploy:
    needs: end-to-end-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9' 
      - uses: aws-actions/setup-sam@v1
      - uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-2
      - run: terraform init
        working-directory: CRC_Terraform
      - run: terraform fmt
        working-directory: CRC_Terraform
      - run: terraform validate
        working-directory: CRC_Terraform
      - run: terraform plan
        working-directory: CRC_Terraform
      - run: terraform apply -auto-approve
        working-directory: CRC_Terraform

  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: jakejarvis/s3-sync-action@master
        env:
          AWS_S3_BUCKET: hms-victory
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          SOURCE_DIR: CRC_Terraform/website-resources
