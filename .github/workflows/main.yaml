name: Pepperoni Workflow
on:
  push:
  workflow_dispatch:

jobs:
  A_setup:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v1

  B_build: 
    needs: A_setup
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Configure AWS credentials
      uses: aws-actions/setup-sam@v1
    - name: Terraform Init
      run: terraform init
      working-directory: WordPress Hosted on EC2
    - name: Terraform Format
      run: terraform fmt
      working-directory: WordPress Hosted on EC2
    - name: Terraform Validate
      run: terraform validate
      working-directory: WordPress Hosted on EC2
    - name: Terraform Plan
      run: terraform plan
      working-directory: WordPress Hosted on EC2
    - name: Terraform Apply
      run: terraform apply -auto-approve
      working-directory: WordPress Hosted on EC2

  C_setup_server_config:
    needs: B_build
    runs-on: ubuntu-latest
    steps:
    - name: Assign Setup Server Instance ID and Public IP
      run: |
        INSTANCE_ID=$(terraform output -raw instance_id)
        echo "Instance ID: $INSTANCE_ID"
        echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV

        PUBLIC_IP=$(aws ec2 describe-instances --instance-ids $INSTANCE_ID --query "Reservations[0].Instances[0].PublicIpAddress" --output text)
        echo "Instance Public IP: $PUBLIC_IP"
        echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV

  D_install_gh_cli:
    needs: C_setup_server_config
    runs-on: ubuntu-latest
    steps:
    - name: Install GitHub CLI
      run: |
        # Install GitHub CLI on the remote server
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list
        sudo apt update
        sudo apt install gh

  E_install_gh_cli:
    needs: D_install_gh_cli
    runs-on: ubuntu-latest
    steps:
    - name: Authenticate GitHub CLI
      run: |
        gh auth login --with-token <<< ${{ secrets.GH_TOKEN }}

  F_save_private_key:
    needs: E_install_gh_cli
    runs-on: ubuntu-latest
    steps:
    - name: Save Private Key to GitHub Actions secrets
      run: # ./save_private_key.sh (This line is a placeholder and should be replaced with the actual script)
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

  G_configure_EC2_instance:
    needs: F_save_private_key
    runs-on: ubuntu-latest
    steps:
    - name: Use Public IP to SSH into Setup Server and Configure EC2 Instance
      uses: appleboy/ssh-action@master
      with:
        host: ${{ env.PUBLIC_IP }}
        username: ec2-user
        key: ${{ secrets.PEPPERONI_SETUP_SERVER_TF_KEY }}  # Replace with the name of your SSH private key secret
        script: |
          sudo su
          yum update -y
          # Rest of the configuration steps...

  H_configure_private_server:
    needs: G_configure_EC2_instance
    runs-on: ubuntu-latest
    steps:
    - name: SSH into Private Server and Configure it
      uses: appleboy/ssh-action@master
      with:
        host: ${{ env.BASTION_HOST_PUBLIC_IP }}
        username: ec2-user
        key: ${{ secrets.PEPPERONI_SETUP_SERVER_TF_KEY }}  # Replace with the name of your SSH private key secret
        script: |
          ssh-add - <<< "${{ secrets.PEPPERONI_SETUP_SERVER_TF_KEY }}"
          ssh -A -i ${{ secrets.PEPPERONI_SETUP_SERVER_TF_KEY }} ec2-user@${{ env.BASTION_HOST_PUBLIC_IP }}
          ssh -i ${{ secrets.PEPPERONI_SETUP_SERVER_TF_KEY }} ec2-user@${{ env.BASTION_HOST_PRIVATE_IP }}
